name: Build Rust Xous with Guix

on:
  push:
    branches: [main, ci*]
  pull_request:
    branches: [main]

jobs:
  build-dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Guix
        uses: sbellem/guix-install-action@dev
        with:
          version: "1.5.0"
          pullAfterInstall: false

      - name: Dry-run build rust-xous
        run: |
          guix time-machine \
            --channels=channels.scm \
            -- build -L . -e '(@ (rust-xous) rust-xous)' --dry-run

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Guix
        uses: sbellem/guix-install-action@dev
        with:
          version: "1.5.0"
          pullAfterInstall: false

      - name: Build rust-xous
        run: |
          guix time-machine \
            --channels=channels.scm \
            -- build -L . -e '(@ (rust-xous) rust-xous)'

      - name: Test rust-xous toolchain
        run: |
          RUST_XOUS=$(guix time-machine \
            --channels=channels.scm \
            -- build -L . -e '(@ (rust-xous) rust-xous)')
          echo "Built: $RUST_XOUS"

          # Verify rustc and cargo work
          $RUST_XOUS/bin/rustc --version
          $RUST_XOUS/bin/cargo --version

          # Check xous target is available
          $RUST_XOUS/bin/rustc --print target-list | grep -q xous \
            && echo "Xous target available"

          # Test compiling a simple no_std program for xous target
          cat > /tmp/test.rs << 'EOF'
          #![no_std]
          #![no_main]
          #[panic_handler]
          fn p(_: &core::panic::PanicInfo) -> ! { loop {} }
          EOF
          $RUST_XOUS/bin/rustc \
            --target riscv32imac-unknown-xous-elf \
            -C panic=abort --emit=obj -o /tmp/test.o /tmp/test.rs
          file /tmp/test.o | grep -q "RISC-V" \
            && echo "Successfully compiled for RISC-V xous target"

      - name: Upload build result info
        run: |
          RUST_XOUS=$(guix time-machine \
            --channels=channels.scm \
            -- build -L . -e '(@ (rust-xous) rust-xous)')
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Store path: \`$RUST_XOUS\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Toolchain info" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          $RUST_XOUS/bin/rustc --version >> $GITHUB_STEP_SUMMARY
          $RUST_XOUS/bin/cargo --version >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Available targets with 'xous':" >> $GITHUB_STEP_SUMMARY
          $RUST_XOUS/bin/rustc --print target-list | grep xous >> $GITHUB_STEP_SUMMARY \
            || echo "none found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
